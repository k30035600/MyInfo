# 카테고리 분류 시스템 코드 프롬프트

## 개요

은행 거래 내역(bank_before.xlsx)을 카테고리 테이블(category_table.xlsx)의 키워드와 매칭하여 카테고리를 자동으로 분류하고 적용하는 시스템입니다.


## 시스템 구조

### 입력 파일
- `bank_before.xlsx`: 전처리된 은행 거래 내역 데이터(커테고리처리전 데이터)
- `category_table.xlsx`: 키워드-카테고리 매핑 테이블 (컬럼: 차수, 키워드, 카테고리)

### 출력 파일
- `bank_after.xlsx`: 카테고리가 적용된 은행 거래 내역 데이터(커테고리처리후 데이터)


## 카테고리 분류 단계별 처리 순서

### before_text 생성

**목적**:
- 이후 단계에서 키워드 매칭을 위한 통합 텍스트 생성

**생성 방식**:
- 적요가 공백이면 은행명을 대괄호로 감싸기: `[은행명]`
- 내용이 공백이면 은행명을 대괄호로 감싸기: `[은행명]`
- `구분/적요/내용/송금메모`를 "#"로 연결
- 예: "출금#ATM#12345#송금메모", "출금#[은행명]#[은행명]#송금메모"

---

### 1차 분류: 입출금 구분

**목적**:
- 입금/출금 구분

**처리 로직**:
- 입금액과 출금액을 기반으로 판단
- 입금액 > 0이면 "입금”
- 출금액 > 0이면 "출금"
- 입금액 = 0 and 출금액 = 0 이면 "입금” 

**적용 컬럼**: `입출금`

---

### 2차 분류: before_text 2차 키워드 매칭

**목적**:
- before_text의 개별 컬럼에서 2차 키워드를 매칭하여 카테고리로 교체

**처리 컬럼**:
- `구분`, `적요`, `내용`, ‘거래점’, `송금메모`

**처리 내용**:
- before_text에서 category_table의 차수 "2차" 키워드와 매칭
- 매칭된 키워드가 있으면 해당 컬럼의 택스트를 카테고리로 교체: ‘주식회사’ → ‘㈜’
- 긴 키워드부터 우선 매칭 (예: "대출이자" → "대출" 순서)

**계좌번호 처리** (적요/내용 컬럼에만):
- 8자 이상 연속된 숫자는 전체를 대괄호로 감싸기: `[J12345678[]’, ‘[12345678]’

**2차분류 코드**:
- category_table의 차수 "2차"에 정의된 카테고리 값들

---

### 3차 분류: 거래유형

**목적**:
- 거래 방법/유형 분류 (ATM, 뱅킹, 대출, 카드 등)

**처리 로직**:
- before_text에서 category_table의 차수 "3차" 키워드와 매칭
- 매칭된 키워드가 있으면 category_table의 카테고리를 ‘거래유형’
- 카테고리가 “대출”, 입금액 > 0이면 ‘“잡수입”’을 ‘거래유형’
- 긴 키워드부터 우선 매칭

**3차분류 코드 (거래유형)**:
- 카테고리테이블의 차수 "3차"에 정의된 카테고리 값들

**키워드와 카테고리 매핑 예시**:
- 키워드 `"ATM"` → 카테고리 `"ATM"`
- 키워드 `"CMS"` → 카테고리 `"CMS"`
- 키워드 `"뱅킹"` → 카테고리 `"기업뱅킹"`, `"뱅킹"`, `"송금"`, `"스타뱅"`, `"이체"`, `"인터넷뱅킹"`, `"펌뱅킹"`
- 키워드 `"대출"`, `"이자"`, `"대출이자"`, `"대출원금"` → 카테고리 `"대출"`
- 키워드 `"스마트"` → 카테고리 `"모바일"`, `"스마트"`, `"인터넷"`, `"전자금융"`
- 키워드 `"카드"` → 카테고리 `"카드"`
- 키워드 `"타행환"` → 카테고리 `"타행환"`
- 키워드 `"현금"` → 카테고리 `"현금"`, `"현금서비스"`

**기본값**:
- `"기타거래"` (키워드 매칭 실패 시)

**적용 컬럼**:
- `거래유형`, ‘거래방법’

---

### 4차 분류: 거래방법

**목적**:
- 거래 상대방 분류

**처리 로직**:
- before_text에서 category_table의 차수 "4차" 키워드와 매칭
- 매칭된 키워드가 있으면 category_table의 카테고리를 ‘거래방법’
- 긴 키워드부터 우선 매칭

**4차분류 코드** (거래방법):
- category_table의 차수 "4차"에 정의된 카테고리 값들

**기본값**:
- `"개인"` (키워드 매칭 실패 시)

**적용 컬럼**:
- `거래방법`

---

### 5차 분류: 거래지점

**목적**:
- 거래 지점/은행 분류

**처리 로직**:
1. category_table의 차수 "5차" 키워드와 매칭 시도
   - before_text에서 차수 "5차" 키워드 매칭
   - 매칭된 키워드가 있으면 category_table의 카테고리를 ‘거래지점’
   - 긴 키워드부터 우선 매칭
2. 매칭되지 않으면 기존 로직 수행:
   - 거래점을 ‘거래지점’

**5차분류 코드** (거래지점):
- category_table의 차수 "5차"에 정의된 카테고리 값들

**기본값**:
- `"미분류"` (키워드 매칭 실패 시)

**적용 컬럼**:
- `거래지점`

---

### 6차 분류: 기타거래

**목적**:
- 기타 추가 정보 분류

**처리 로직**:
1. before_text가 공백이면 적요를 ‘기타거래’
3. category_table의 차수 "6차" 키워드와 매칭 시도
   - before_text에서 키워드 매칭
   - 매칭된 키워드가 있으면 category_table의 카테고리를 before_text의 키워드와 교체
   - before_text의 택스트가 ‘space’, ‘SPACE’는 택스트를 “”와 교체
4. 매칭되지 않으면 기존 로직 수행:
   - 대괄호로 감싼 은행명 제외: ‘[하나은행]’
   - 입금/출금, 거래지점, 은행명 제외
4. before_text를 ‘기타거래’(최대 30자 제한)

**6차분류 코드**:
- category_table의 차수 "6차"에 정의된 카테고리 값들

**기본값**:
- 빈 문자열 `""`

**적용 컬럼**:
- `기타거래`

---

## 카테고리 차수별 컬럼 매핑

| 차수 | 컬럼명 | 설명 |
|------|--------|------|
| 1차 | 입출금 | 입금/출금 |
| 2차 | 전처리 | 계좌번호 등 |
| 3차 | 거래유형 | 거래 방법 (ATM, 뱅킹, 대출, 카드 등) |
| 4차 | 거래방법 | 거래 상대방 |
| 5차 | 거래지점 | 거래 지점/은행 |
| 6차 | 기타거래 | 기타 추가 정보 |

## 키워드 매칭 규칙

### 매칭 우선순위
1. **긴 키워드부터 우선 매칭**: 키워드를 길이순으로 정렬하여 긴 키워드부터 검사
   - 예: "대출이자" → "대출" 순서

### 매칭 방식
- **부분 문자열 매칭**: `keyword in before_text`
- **대소문자 구분**: 합니다
- **한 번만 매칭**: 첫 번째 매칭된 키워드만 사용 (break)
- **매칭 후 제거**: 매칭된 키워드를 before_text에서 제거하여 중복 매칭 방지

## 유틸리티 함수

### safe_str(value)
- NaN 값 처리 및 안전한 문자열 변환
- 정규화: 특수 문자 처리:
- 예: 열린 괄호 없는 닫힌 괄호, 닫힌 괄호 없는 열린 괄호 등

### normalize_text(text)
- 텍스트 정규화 (대소문자 구분합니다)

## 출력 컬럼 순서

```python
['거래일', '거래시간', '은행명', '계좌번호', '입금액', '출금액', '잔액',
 '구분', '적요', '내용', '거래점', '송금메모',
 '입출금', '거래유형', '거래방법', '거래지점', '기타거래']
```

## 실행 흐름

1. 입력 파일 로드 (`bank_before.xlsx`)
2. 카테고리 테이블 로드 (`category_table.xlsx`)
3. 카테고리 테이블을 차수별로 분류
4. **before_text 생성**: 구분/적요/내용/거래점/송금메모 조합
5. **1차 분류**: 입출금 구분
5. **2차 분류**: before_text 조합 전 1차 키워드 매칭 및 계좌번호 처리
7. **3차 분류**: 거래유형 분류
8. **4차 분류**: 거래방법 분류
9. **5차 분류**: 거래지점 분류
10. **6차 분류**: 기타거래 분류
11. 결과 저장 (`bank_after.xlsx`)

## 주요 특징

- **점진적 처리**: 각 단계에서 매칭된 키워드를 before_text에서 제거하여 다음 단계 매칭 정확도 향상
- **유연한 매칭**: 키워드가 여러 카테고리에 매핑될 수 있음
- **기본값 처리**: 매칭 실패 시 기본값 설정 ("미분류" 또는 빈 문자열)
- **안전한 데이터 처리**: NaN, 빈 값 등 예외 상황 처리

