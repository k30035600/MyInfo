# 카드 매칭 이슈 원인과 수정

## 1. 국민카드 가맹점 사업자번호가 전처리 후 사업자번호와 매칭되지 않던 이유

### 원인
- **HEADER_TO_STANDARD**에 `가맹점 사업자번호`(공백 포함)가 없었음. 국민카드 Source는 "가맹점 사업자번호"로 되어 있는 경우가 많아, 공백 없는 `가맹점사업자번호`만으로는 일부 셀과 정규화 결과가 달라 매칭이 누락될 수 있음.
- **헤더 행 판별**이 `match_count >= 2` 및 `match_count >= non_empty * 0.5`로만 동작해, 국민카드처럼 컬럼 수가 많고 매칭되는 헤더가 적은 경우 첫 행이 헤더로 인식되지 않을 수 있음. 그러면 `idx_to_std`가 만들어지지 않아 사업자번호 컬럼 매핑 자체가 없어짐.

### 수정 내용
- **process_card_data.py**
  - `HEADER_TO_STANDARD['사업자번호']`에 `'가맹점 사업자번호'`(공백 포함) 추가.
  - **매핑이 없을 때(idx_to_std is None)** 첫 번째 비공백 행을 무조건 헤더로 사용해 `_build_mapping_from_header_row(row)`로 인덱스 매핑을 만듦.  
    → 국민카드처럼 헤더 형식이 달라도 1행 기준으로 사업자번호 등 컬럼 매핑이 이루어짐.

---

## 2. 카드사를 파일명에서 취득하기로 했는데 매칭되지 않던 이유

### 원인
- 카드사는 `_card_company_from_filename(name)`으로 파일명에서 구한 뒤 `_row_from_mapping(..., card_company_from_file)`에서 `new_row['카드사']`에 넣고 있어, **로직 자체는 파일명 기준**으로 동작함.
- 다만 **헤더 행이 한 번도 인식되지 않으면** `idx_to_std`가 None인 채로 유지되어, 데이터 행이 한 건도 출력되지 않음. 그 결과 card_before.xlsx에 카드사가 채워진 행이 없어 “매칭이 안 된다”처럼 보였음.

### 수정 내용
- 위 1번과 동일하게 **매핑이 없을 때 첫 비공백 행을 헤더로 사용**하도록 변경함.  
  → 데이터 행이 정상적으로 출력되고, 그때마다 `card_company_from_file`으로 카드사가 설정됨.
- Source 파일명은 `카드사_기타.xlsx` 형태(예: `국민카드_2024.xlsx`)로 두면, `_` 앞 부분이 카드사로 들어가도록 이미 구현되어 있음.

---

## 3. 전처리 전에 카테고리 파일이 없을 때 모든 파일을 읽고 card_category를 만들지 못하던 이유

### 원인
- **card_app.py**의 `_call_integrate_card()`에서:
  - `integrate_card_excel()`로 card_before.xlsx를 만든 뒤,
  - `card_category.xlsx`가 없으면 `create_category_table(df 또는 None)`로 생성하도록 되어 있음.
- 그런데 **예외가 나면 `except Exception: pass`로 삼켜서** 실패 원인을 알 수 없었고, 사용자 입장에서는 “만들어지지 않는다”만 보이게 됨.
- card_before가 비어 있거나, 읽기/쓰기 권한·경로 문제로 `create_category_table`이 실패해도 로그가 없어 원인 추적이 어려웠음.

### 수정 내용
- **card_app.py** `_call_integrate_card()`:
  - card_before가 존재하고 크기 > 0일 때만 `df`를 읽어서 `create_category_table(df, ...)` 호출하고,  
    비어 있거나 없으면 `create_category_table(None, ...)`로 기본 규칙만으로 생성하도록 분기 유지.
  - **예외 처리**에서 `except Exception: pass` 대신, 예외 메시지와 `traceback.print_exc()`를 출력하도록 변경.  
    → 카테고리 파일 생성 실패 시 콘솔/로그에서 원인 확인 가능.

---

## 요약

| 이슈 | 원인 | 수정 |
|------|------|------|
| 국민카드 가맹점 사업자번호 미매칭 | ① 사업자번호 키워드에 '가맹점 사업자번호' 미포함 ② 첫 행이 헤더로 인식되지 않아 매핑 자체가 없음 | ① 키워드 추가 ② 매핑 없을 때 첫 비공백 행을 헤더로 사용 |
| 카드사 파일명 취득이 안 되는 것처럼 보임 | 헤더 미인식으로 데이터 행이 출력되지 않아 카드사가 채워진 행이 없음 | 동일하게 첫 비공백 행 헤더 사용으로 데이터 행 출력 보장 |
| 전처리 시 card_category 미생성 | 예외를 무시해 실패 원인을 알 수 없음 | 예외 로그 및 traceback 출력 |

위 수정으로 국민카드 사업자번호 매칭, 카드사(파일명), 전처리 시 카테고리 파일 생성이 동작하도록 맞춰 두었습니다.

---

## 4. card_category.xlsx를 생성하지 못하는 이유 (추가)

### 가능한 원인
- **경로**: `category_filepath`가 상대 경로이거나, 현재 작업 디렉터리(cwd)가 예상과 다를 때 다른 폴더에 생성되거나 실패할 수 있음.
- **부모 디렉터리 없음**: 저장 경로의 상위 폴더가 없으면 `to_excel`이 실패할 수 있음.
- **호출 시점**: 카테고리 파일은 **전처리(통합)** 실행 시 또는 **카테고리 API(/api/card_category) 최초 조회 시**에만 생성됨. 그 전에는 생성되지 않음.
- **권한/잠금**: OneDrive 동기화, 다른 프로그램에서 파일 사용 중이면 쓰기 실패할 수 있음.

### 수정 내용
- **process_card_data.py** `create_category_table`  
  - 저장 경로를 `Path(…).resolve()`로 **절대 경로로 통일**.  
  - 저장 직전에 **부모 디렉터리**를 `os.makedirs(..., exist_ok=True)`로 생성.
- **card_app.py** `_call_integrate_card`  
  - 카테고리 생성 전에 `CATEGORY_PATH.parent.mkdir(parents=True, exist_ok=True)`로 부모 디렉터리 보장.  
  - `create_category_table`에 **절대 경로** `str(CATEGORY_PATH.resolve())` 전달.
- **card_app.py** `GET /api/card_category`  
  - 파일이 없을 때 **빈 파일 대신** `create_category_table(None, ...)`로 **기본 규칙이 들어간 card_category.xlsx**를 생성하도록 변경.  
  - 실패 시에만 기존처럼 빈 DataFrame으로 저장.  
  - 부모 디렉터리 생성 후 저장.
