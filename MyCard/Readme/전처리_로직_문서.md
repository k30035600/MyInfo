# 전처리 페이지 로직 문서

## 개요
전처리 페이지는 은행 거래 내역 원본 파일(전처리전)과 전처리된 통합 파일(전처리후)을 비교하여 확인할 수 있는 페이지입니다.

## 페이지 구조

### 1. 좌측 박스: 전처리전
- **데이터 소스**: `Source/` 폴더의 원본 파일들 (국민은행, 신한은행, 하나은행)
- **API 엔드포인트**: `/api/source-data`
- **필터링**: 은행명, 년도, 파일명

### 2. 우측 박스: 전처리후
- **데이터 소스**: `은행거래_전처리_1차.xlsx` (통합 파일)
- **API 엔드포인트**: `/api/processed-data`
- **필터링**: 은행명, 년도

---

## 전처리 로직 (백엔드)

### 파일 위치
- **스크립트**: `integrate_bank_transactions.py`
- **출력 파일**: `은행거래_전처리_1차.xlsx`

### 처리 단계

#### 1. 은행별 파일 읽기

##### 국민은행 (`read_kb_file`)
- HTML 형식 파일 읽기
- 테이블 2번이 실제 데이터
- 계좌번호 추출 (파일명 또는 테이블 1에서)
- 거래일시 분리 (거래일, 거래시간)
- 표준 컬럼명으로 변환

##### 신한은행 (`read_sh_file`)
- Excel 파일 읽기
- 헤더 행 찾기 (15행 이내에서 "거래일자" 포함)
- 계좌번호 추출 (파일명 또는 5행 이내에서)
- 표준 컬럼명으로 변환

##### 하나은행 (`read_hana_file`)
- Excel 파일 읽기
- 헤더 행 찾기 (15행 이내에서 "거래일시" 또는 "거래일" 포함)
- 계좌번호 추출 (파일명 또는 5행 이내에서)
- 거래일시 분리 (거래일, 거래시간)
- 표준 컬럼명으로 변환

#### 2. 데이터 정리
- **금액 정리** (`clean_amount`):
  - 쉼표 제거
  - 빈 값, '-', 0 처리
  - 숫자 변환

#### 3. 데이터 통합
- 모든 은행 데이터를 하나의 DataFrame으로 통합
- 거래일, 거래시간, 은행명, 계좌번호 순으로 정렬
- 거래일이 없는 행 제거

#### 4. 컬럼 순서 정리
표준 컬럼 순서:
1. 거래일
2. 거래시간
3. 은행명
4. 계좌번호
5. 입금액
6. 출금액
7. 잔액
8. 구분
9. 적요
10. 내용
11. 거래점
12. 송금메모
13. 메모

#### 5. 파일 저장
- `은행거래_전처리_1차.xlsx`로 저장

---

## 전처리전 데이터 집계 로직 (프론트엔드)

### 파일 위치
- **함수**: `templates/index.html`의 `loadLeftData()` 함수

### 처리 단계

#### 1. 파일 단위 처리
- 각 파일별로 독립적으로 처리

#### 2. 헤더 행 감지
**조건**: 값에 "거래" AND "입금" AND "출금" 모두 포함되는 행
```javascript
const isHeaderRow = hasTrade && hasDeposit && hasWithdraw;
```

#### 3. 헤더 이후 데이터 처리
- 헤더 검출 후 다음 헤더(또는 파일 끝)까지의 모든 행 처리

#### 4. 컬럼 키 추출
헤더 행에서 다음 컬럼 키를 찾습니다:
- `tradeColumnKeys`: "거래" 포함
- `depositColumnKeys`: "입금" 포함
- `withdrawColumnKeys`: "출금" 포함

#### 5. 데이터 행 처리 (각 레코드)
```javascript
// 1. 거래 컬럼 확인
let hasTrade = false;
tradeColumnKeys.forEach(colKey => {
    const val = dataRow[colKey];
    if (val !== null && val !== undefined && val !== '') {
        hasTrade = true;
    }
});

// 2. 거래 컬럼이 없으면 skip
if (!hasTrade) {
    continue;
}

// 3. 입금/출금 값 추출 및 숫자 변환
let depositValue = 0;
let withdrawValue = 0;

depositColumnKeys.forEach(colKey => {
    const val = dataRow[colKey];
    if (val !== null && val !== undefined && val !== '') {
        const numStr = String(val).replace(/,/g, '').trim();
        const numVal = parseFloat(numStr);
        if (!isNaN(numVal)) {
            depositValue += numVal;
        }
    }
});

withdrawColumnKeys.forEach(colKey => {
    const val = dataRow[colKey];
    if (val !== null && val !== undefined && val !== '') {
        const numStr = String(val).replace(/,/g, '').trim();
        const numVal = parseFloat(numStr);
        if (!isNaN(numVal)) {
            withdrawValue += numVal;
        }
    }
});

// 4. 입금/출금 금액이 모두 0이면 skip
if (depositValue === 0 && withdrawValue === 0) {
    continue;
}

// 5. 집계
totalCount++;        // 총집계 (모든 레코드 수)
accumCount++;        // 누적집계 (입금/출금이 있는 레코드 수)
totalDeposit += depositValue;
totalWithdraw += withdrawValue;

// 6. 추출된 행 저장 (마지막 컬럼에 "추출" 표시)
const aggregatedRow = { ...dataRow };
aggregatedRow['매칭'] = '추출';
extractedRows.push(aggregatedRow);
```

#### 6. 집계 결과 표시
- **집계**: `총집계 / 누적집계` (예: 1,000 / 850)
- **입금**: 총 입금액 합계
- **출금**: 총 출금액 합계

#### 7. 데이터 표시
- 헤더 행: 마지막 컬럼에 "헤더" 표시
- 추출된 행: 마지막 컬럼에 "추출" 표시
- 나머지 행: 표시만 (마커 없음)

---

## Skip 조건

### 1. 거래 컬럼이 없는 경우
- 데이터 행에서 거래 컬럼 키로 찾은 값이 모두 null/undefined/빈 문자열인 경우

### 2. 입금/출금 금액이 모두 0인 경우
- 입금액과 출금액의 합이 모두 0인 경우

---

## 집계 구분

### 총집계 (totalCount)
- 헤더 행 이후의 **모든 데이터 행** 수
- skip 조건과 무관하게 카운트

### 누적집계 (accumCount)
- skip 조건을 통과한 **유효한 데이터 행** 수
- 즉, 거래 컬럼이 있고, 입금/출금 중 하나라도 0이 아닌 경우

---

## 데이터 흐름

```
Source 폴더 원본 파일
    ↓
[전처리전] - loadLeftData()
    ├─ 헤더 행 감지
    ├─ 데이터 행 처리
    ├─ skip 조건 적용
    └─ 집계 및 표시
    ↓
integrate_bank_transactions.py
    ├─ 은행별 파일 읽기
    ├─ 데이터 정리
    ├─ 데이터 통합
    └─ 은행거래_전처리_1차.xlsx 저장
    ↓
[전처리후] - loadRightData()
    ├─ 통합 파일 읽기
    ├─ 필터링
    └─ 집계 및 표시
```

---

## 주요 특징

1. **파일 단위 처리**: 각 파일을 독립적으로 처리하여 파일별 헤더를 별도로 인식
2. **헤더 자동 감지**: "거래", "입금", "출금" 키워드로 헤더 행 자동 감지
3. **유연한 컬럼 매핑**: 헤더에서 동적으로 컬럼 키를 찾아 처리
4. **데이터 검증**: 거래 컬럼 유무 및 입금/출금 금액으로 유효성 검사
5. **시각적 구분**: 헤더와 추출된 행을 "헤더", "추출" 마커로 구분
