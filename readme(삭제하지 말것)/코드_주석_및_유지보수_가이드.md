# 코드 주석 및 유지보수 가이드

코드를 처음부터 따라가며 주석을 달고, 유지보수가 쉽도록 정리한 규칙입니다.

---

## 1. 적용된 주석 구조

### 1.1 파일 상단 docstring (모듈 목적·실행 흐름)

- **app.py**: 통합 서버 진입점. 실행 순서(환경 → 서브앱 로드 → 라우트 등록 → 메인 라우트 → 백그라운드 before/after), 서브앱 prefix, proxy 뷰 동작 요약.
- **cash_app.py**: 금융정보 앱. 목적(전처리 페이지·업종분류 페이지·cash_after 생성), 주요 데이터(cash_after·linkage_table·category_table 역할), 유지보수 시 참고(ensure_working_directory·캐시).
- **bank_app.py**: 은행거래 앱. 목적, 주요 데이터, 유지보수 참고.
- **card_app.py**: 신용카드 앱. 목적, 주요 데이터, 유지보수 참고(process_card_data 동적 로드).

### 1.2 섹션 주석 (블록 구분)

- 형식: `# ----- N. 제목 (한 줄 요약) -----`
- **app.py**: 1. 환경·인코딩, 2. 서브앱 설정, 3. Flask 앱 초기화, 4. 캐시 정리, 5. UTF-8 패치, 6. 서브앱 라우트 등록, 7. 메인 라우트, 8. 백그라운드 before/after, 9. 진입점.
- **cash_app.py**: 경로·상수, 데코레이터·JSON 유틸, 파일·캐시 로드, cash_after 병합, 페이지 라우트, API(원본·전처리·업종분류), API(cash_after 생성), 페이지(분석·도움말).

### 1.3 함수·라우트 docstring

- 공개 API/라우트: 한 줄로 **무엇을 반환·수행하는지** 명시.
- 예: `"""cash_after 생성: bank_after + card_after 병합 후 linkage·위험도 적용. 임시 파일 쓰고 원자적 교체."""`

---

## 2. 유지보수 시 참고

- **경로**: 각 앱은 `SCRIPT_DIR`(자기 폴더), `PROJECT_ROOT`(MyInfo 루트). `.source`, `MyBank`/`MyCard`/`MyCash`는 루트 기준.
- **캐시**: cash_after·linkage_table 등은 파일 변경 시 무효화 후 재로드. 서버 재시작 시 app.py의 `_clear_startup_caches()`로 임시·캐시 정리.
- **서브앱 로드**: app.py의 `load_subapp_routes()`에서 소스 읽기 → UTF-8 블록 패치 → 메모리 로드 → prefix 붙여 라우트 등록. 실패 시 해당 prefix는 폴백 뷰(오류 안내 페이지)만 노출.

---

## 3. 공통 모듈 (리팩토링)

- **shared_app_utils.py** (프로젝트 루트): Bank/Card/Cash에서 중복되던 유틸을 한 곳으로 모음.
  - `make_ensure_working_directory(script_dir)`: cwd 고정 데코레이터 생성. 각 앱에서 `ensure_working_directory = make_ensure_working_directory(SCRIPT_DIR)` 로 사용.
  - `json_safe_val`, `json_safe_records`, `json_safe`: NaN/numpy/datetime → JSON 가능 타입. 각 앱에서는 `_json_safe_val` 등으로 import하여 기존 호출부 유지.
- 서브앱은 `PROJECT_ROOT`를 `sys.path`에 넣은 뒤 `from shared_app_utils import ...` (Bank는 이미 PROJECT_ROOT를 path에 넣고 있음).

---

## 4. 새 코드·수정 시 권장

- 새 라우트 그룹이 생기면 해당 블록 위에 `# ----- API: 설명 -----` 형태로 섹션 추가.
- 새로 공통화할 로직이 생기면 **shared_app_utils.py**에 추가한 뒤, 각 앱에서 import해 사용.
- 새 파일(모듈) 추가 시 상단에 파일 목적·주요 함수·데이터 경로를 3~5줄 docstring으로 작성.
- 복잡한 비즈니스 로직(병합·위험도 적용 등)은 함수 상단에 입출력·사이드 이펙트(캐시 무효화 등)를 한 줄이라도 적어 두기.
